<!doctype html><html lang=en><head><meta charset=utf-8><title>9: more rop</title>
<meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=../reveal-js/css/reset.css><link rel=stylesheet href=../reveal-js/css/reveal.css><link rel=stylesheet href=../reveal-js/css/theme/black.css id=theme><link rel=stylesheet href=../highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section><h2 id=well-get-started-at-16805>We&rsquo;ll get started at 1[68]:05</h2></section><section data-noprocess data-shortcode-slide class=center><h1 id=rop-techniques--revision>rop techniques & revision</h1><h3 id=6447-week9>6447 week9</h3></section><section><h2 id=good-faith-policy>good faith policy</h2><p>we expect a high standard of professionalism from you at all times while you are taking any of our courses. We expect all students to act in good faith at all times</p><p><em>TLDR: Don&rsquo;t be a <del>dick</del> jerk</em></p><p><a href=https://sec.edu.au/good-faith-policy>sec.edu.au/good-faith-policy</a></p></section><section><section data-shortcode-section><h2 id=doing-more-with-rop>doing more with rop</h2></section><section><h3 id=calling-functions>calling functions</h3><p>it&rsquo;s not just syscalls for <code>execve("/bin/sh")</code></p><ul><li><em>won&rsquo;t always be calling assembly instructions</em></li><li>generally you&rsquo;ll have access to many more functions</li><li>probably won&rsquo;t get exactly what you want</li></ul><blockquote><p>malloc, printf, mmap can all leverage other exploits</p></blockquote></section><section><h3 id=www>www</h3><p>write-what-where gadgets</p><ul><li>basically a write primitive as a gadget<ul><li>register 1: the target address</li><li>register 2: the value to write</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>mov</span> [<span style=color:#a6e22e>register1</span>], <span style=color:#a6e22e>register2</span>
</span></span></code></pre></div></section><section><h3 id=using-the-stack>using the stack</h3><p>we can still use the stack to store stuff</p><ul><li>that&rsquo;s where our payload (padding) is<ul><li>we can already write to it (most of the time)</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>    <span style=color:#a6e22e>mov</span> <span style=color:#a6e22e>eax</span>, <span style=color:#a6e22e>esp</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sub</span> <span style=color:#a6e22e>eax</span>, <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mov</span> <span style=color:#a6e22e>ebx</span>, <span style=color:#a6e22e>eax</span>
</span></span></code></pre></div><blockquote><p>not just mov (add, mul, push, xchg?)</p></blockquote></section></section><section><section data-shortcode-section><h2 id=stack-pivots>stack pivots</h2><p>my buffer is too small</p></section><section><h3 id=the-problem>the problem</h3><p>we can&rsquo;t get a full payload</p><ul><li>we have an overflowable buffer</li><li>overflow isn&rsquo;t large enough for a full ROP payload</li></ul><blockquote><p>think back to egghunters in shellcode</p></blockquote></section><section><h3 id=the-solution>the solution</h3><ul><li>we could:<ul><li>jump back earlier in the current buffer</li><li>jump into a bigger buffer (harder/better?)</li></ul></li></ul><blockquote><p>a.k.a we <del>pivot the stack</del></p></blockquote></section></section><section><section data-shortcode-section><h3 id=stack-pivot-example>stack pivot example</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>vuln</span>(){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> buff[<span style=color:#ae81ff>16</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fgets</span>(buff,<span style=color:#ae81ff>24</span>,stdin);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>here, we only have enough room to overwrite a single address</p></blockquote></section><section><h3 id=in-memory>in memory</h3><pre tabindex=0><code>    [  XXXX  ] *we cannot write here*
    [  GDGT  ] &lt;- stored return pointer
    [  AAAA  ] &lt;- stored frame pointer
    [  AAAA  ] &lt;- padding
    [  AAAA  ]
    [  AAAA  ]
    [  AAAA  ]
</code></pre><blockquote><p>we can overwrite the return address, but can only execute one instruction?</p></blockquote></section><section><h3 id=stack-pivot-in-action>stack pivot in action</h3><p><code>GADGET_1</code> = <code>sub esp, 24</code></p><pre tabindex=0><code>[ GADGET_1 ] &lt;- ESP points here 
[   AAAA   ]
[   AAAA   ]
[   AAAA   ]
[   AAAA   ]
[   AAAA   ]
[ GADGET_2 ] &lt;- start of our payload 
</code></pre><blockquote><p>GADGET_1 gets invoked</p></blockquote></section><section><h3 id=stack-pivot-in-action-1>stack pivot in action</h3><p>gadget moves ESP to point at the start of our payload</p><pre tabindex=0><code>[ GADGET_1 ]
[   AAAA   ]
[   AAAA   ]
[   AAAA   ]
[   AAAA   ]
[   AAAA   ]
[ GADGET_2 ] &lt;- ESP points here 
</code></pre></section><section><h3 id=stack-pivot-in-action-2>stack pivot in action</h3><p>so put our ROPChain as our &ldquo;padding&rdquo;</p><pre tabindex=0><code>[ GADGET_1 ] &lt;- ESP points here 
[ GADGET_8 ] &lt;- int 0x80
[ GADGET_7 ] &lt;- xor esi, esi; ret
[ GADGET_5 ] &lt;- xor edx, edx; ret
[ GADGET_4 ] &lt;- mov ecx, 0x12345678; ret
[ GADGET_3 ] &lt;- mov ebx, 0x12345678; ret
[ GADGET_2 ] &lt;- mov eax, 11; ret
</code></pre></section><section><h3 id=other-stack-pivots>other stack pivots</h3><p>it could be the same buffer or another one</p><ul><li>if it&rsquo;s another buffer, you&rsquo;ll just need to move esp more</li><li>or directly change it&rsquo;s value (with a leak maybe?)</li></ul></section></section><section><section data-shortcode-section><h2 id=stack-pivots-extreme>stack-pivots (extreme!!)</h2><ul><li>what if we only had a single byte overflow</li><li>e.g. we overwrite one byte of EBP</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>vuln</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> buffer[<span style=color:#ae81ff>100</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fgets</span>(buffer, <span style=color:#ae81ff>101</span>, stdin);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>how2exploit?</p></blockquote></section><section><h3 id=how-realistic-is-this>how realistic is this?</h3><p>why is this vulnerable?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>vuln</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>s) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> buffer[<span style=color:#ae81ff>100</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(buffer, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strncat</span>(buffer, s, <span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></section><section><h3 id=what-is-the-bug>what is the bug?</h3><p>these should be <code>sizeof(buffer) - 1</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>vuln</span>(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>s) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> buffer[<span style=color:#ae81ff>100</span>];
</span></span><span style=display:flex><span>    <span style=color:#75715e>//                vvvvvvvvvvvvvv
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>memset</span>(buffer, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strncat</span>(buffer, s, <span style=color:#66d9ef>sizeof</span>(buffer));
</span></span><span style=display:flex><span>    <span style=color:#75715e>//                 ^^^^^^^^^^^^^^
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></section><section><h3 id=how-to-exploit-this>how to exploit this?</h3><p>its only one byte</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#ae81ff>0xFFFF</span> [ <span style=color:#a6e22e>ABCD</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>stored</span> <span style=color:#a6e22e>EIP</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFFC</span> [ <span style=color:#a6e22e>FFFF</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>stored</span> <span style=color:#a6e22e>EBP</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFF8</span> [ <span style=color:#a6e22e>AAAA</span> ]
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFF4</span> [ <span style=color:#a6e22e>AAAA</span> ]
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFF0</span> [ <span style=color:#a6e22e>AAAA</span> ]
</span></span></code></pre></div></section><section><h3 id=leave-and-ret>leave and ret</h3><p>what do leave and ret do?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>leave</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mov</span> <span style=color:#a6e22e>esp</span>, <span style=color:#a6e22e>ebp</span>    <span style=color:#75715e>// esp = ebp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>pop</span> <span style=color:#a6e22e>ebp</span>         <span style=color:#75715e>// ebp = old_ebp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ret</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pop</span> <span style=color:#a6e22e>eax</span>         <span style=color:#75715e>// eax = stored_eip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>call</span> <span style=color:#a6e22e>eax</span>        <span style=color:#75715e>// jump eax
</span></span></span></code></pre></div></section><section><h3 id=the-overflow>the overflow</h3><p>overflow into least significant byte</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#ae81ff>0xFFFF</span> [ <span style=color:#a6e22e>ABCD</span> ]
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFFC</span> [ <span style=color:#a6e22e>FFF0</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>partial</span> <span style=color:#a6e22e>overwrite</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFF8</span> [ <span style=color:#a6e22e>AAAA</span> ]
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFF4</span> [ <span style=color:#a6e22e>AAAA</span> ]
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFF0</span> [ <span style=color:#a6e22e>AAAA</span> ]
</span></span></code></pre></div></section><section><h3 id=redirecting-program-flow>redirecting program flow</h3><blockquote><p>once we leave, ESP points to <code>0xFFF0</code></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#ae81ff>0xFFFF</span> [ <span style=color:#a6e22e>ABCD</span> ]
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFFC</span> [ <span style=color:#a6e22e>FFFF</span> ]
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFF8</span> [ <span style=color:#a6e22e>AAAA</span> ]
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFF4</span> [ <span style=color:#a6e22e>AAAA</span> ]
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xFFF0</span> [ <span style=color:#a6e22e>AAAA</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ESP</span> <span style=color:#a6e22e>points</span> <span style=color:#a6e22e>here</span> (<span style=color:#a6e22e>execution</span> <span style=color:#a6e22e>resumes</span> <span style=color:#a6e22e>here</span>)
</span></span></code></pre></div></section></section><section><section data-shortcode-section><h2 id=srop>srop</h2><p>sig-return oriented programming</p></section><section><h3 id=what-is-sigreturn>what is sigreturn</h3><p>how kernel returns execution to program after signal</p><ul><li><p>when a signal is invoked, the context (e.g. registers) are all pushed to the stack</p></li><li><p>the signal-handler may modify them, etc</p></li><li><p>these values are restored using sigreturn (a syscall)</p></li></ul></section><section><h3 id=so-how-could-we-exploit-this>so how could we exploit this</h3><p>we fake a sigreturn</p><ul><li><p>sigreturn restores the values of registers <strong>based</strong> on content stored on the stack (we control the stack)</p></li><li><p>what if we pushed our own fake &ldquo;context&rdquo; (register values) onto the stack, and triggerd a sigreturn?</p></li><li><p>we could control all of the register values?</p></li></ul></section></section><section><h2 id=revision>revision</h2><p>need help?</p><ul><li><p>any content you want covered?</p></li><li><p>any challenges you want me to demo?</p></li></ul></section><section><h2 id=tutorial>tutorial</h2></section></div></div><script type=text/javascript src=../reveal-hugo/object-assign.js></script><a href=../reveal-js/css/print/ id=print-location style=display:none></a><script type=text/javascript>var printLocationElement=document.getElementById("print-location"),link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?"pdf.css":"paper.css"),document.getElementsByTagName("head")[0].appendChild(link)</script><script type=application/json id=reveal-hugo-site-params>null</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=../reveal-js/js/reveal.js></script><script type=text/javascript>function camelize(e){return e&&Object.keys(e).forEach(function(t){newK=t.replace(/(_\w)/g,function(e){return e[1].toUpperCase()}),newK!=t&&(e[newK]=e[t],delete e[t])}),e}var revealHugoDefaults={center:!0,controls:!0,history:!0,progress:!0,transition:"slide"},revealHugoSiteParams=JSON.parse(document.getElementById("reveal-hugo-site-params").innerHTML),revealHugoPageParams=JSON.parse(document.getElementById("reveal-hugo-page-params").innerHTML),options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options)</script><script type=text/javascript src=../reveal-js/plugin/markdown/marked.js></script><script type=text/javascript src=../reveal-js/plugin/markdown/markdown.js></script><script type=text/javascript src=../reveal-js/plugin/highlight/highlight.js></script><script type=text/javascript src=../reveal-js/plugin/zoom-js/zoom.js></script><script type=text/javascript src=../reveal-js/plugin/notes/notes.js></script></body></html>