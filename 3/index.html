<!doctype html><html lang=en><head><meta charset=utf-8><title>3: shellcode</title>
<meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=../reveal-js/css/reset.css><link rel=stylesheet href=../reveal-js/css/reveal.css><link rel=stylesheet href=../reveal-js/css/theme/black.css id=theme><link rel=stylesheet href=../highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section><h2 id=well-get-started-at-1805>We&rsquo;ll get started at 18:05</h2></section><section data-noprocess data-shortcode-slide class=center><h1 id=shellcode>shellcode</h1><h3 id=6447-week3>6447 week3</h3></section><section><h2 id=good-faith-policy>Good faith policy</h2><p>We expect a high standard of professionalism from you at all times while you are taking any of our courses. We expect all students to act in good faith at all times</p><p><em>TLDR: Don&rsquo;t be a <del>dick</del> jerk</em></p><p><a href=https://sec.edu.au/good-faith-policy>sec.edu.au/good-faith-policy</a></p></section><section><section data-shortcode-section><h2 id=todo>todo</h2><ul><li>reverse engineering</li><li>shellcode</li><li>memory protections (again)</li></ul></section><section><h3 id=harder-re>harder re</h3><p>instructions can give context to the variables</p><p><img src=../assets/img/week03/operation_implications.png alt></p></section><section><h3 id=harder-re-2>harder re #2</h3><p>what&rsquo;s different between these instructions?</p><pre tabindex=0><code>    mov eax, dword ptr [esp]
    mov eax, word ptr [esp]
    mov eax, byte ptr [esp]
    mov ax, [esp]
    mov al, [esp]
</code></pre></section><section><h3 id=finding-offsets>finding offsets</h3><p>some people seemed to be confused</p><ul><li>binja: var_30 means the variable is 0x30 (48) bytes away from the return address</li><li>assembly: variable ebp-0x2B means it&rsquo;s 0x2B (44) bytes away from stored EBP</li></ul></section></section><section><section data-shortcode-section><h2 id=buffer-overflows>buffer overflows</h2></section><section><h3 id=last-week-recap>last week recap</h3><ul><li><p>last week we had a nice win() function to jump to</p></li><li><p>so we overwrite EIP with that function pointer</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>win</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>at</span> <span style=color:#ae81ff>0xDEADBEEF</span><span style=color:#f92672>.</span> <span style=color:#a6e22e>gimme</span> <span style=color:#a6e22e>some</span> <span style=color:#a6e22e>data</span> <span style=color:#a6e22e>though</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>AAAAAAAAAAAAAAAAAAA\xEF\xBE\xAD\xDE</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wait</span> <span style=color:#a6e22e>how</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>d</span> <span style=color:#a6e22e>you</span> <span style=color:#a6e22e>get</span> <span style=color:#a6e22e>here</span><span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#a6e22e>rm</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>rf</span> <span style=color:#f92672>/*</span>
</span></span></code></pre></div></section><section><h3 id=last-week-recap-1>last week recap</h3><p>what does it look like in memory</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>    <span style=color:#ae81ff>0x18</span>  [   <span style=color:#a6e22e>ARGS</span>   ] 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x14</span>  [ <span style=color:#a6e22e>DEADBEEF</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>EIP</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x10</span>  [ <span style=color:#ae81ff>41414141</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>EBP</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x0C</span>  [ <span style=color:#ae81ff>41414141</span> ] 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x08</span>  [ <span style=color:#ae81ff>41414141</span> ]
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x04</span>  [ <span style=color:#ae81ff>41414141</span> ]
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x00</span>  [ <span style=color:#ae81ff>41414141</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>buffer</span>
</span></span></code></pre></div></section><section><h3 id=some-suggestions>some suggestions</h3><p>dont hardcode stuff</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>payload <span style=color:#f92672>=</span> fit({<span style=color:#ae81ff>10</span>: <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;abcd&#39;</span>, <span style=color:#ae81ff>100</span>: <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;efgh&#39;</span>}, filler<span style=color:#f92672>=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># kinda equivalent to</span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A&#39;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;abcd&#39;</span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;A&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>100</span> <span style=color:#f92672>-</span> len(payload))
</span></span><span style=display:flex><span>payload <span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;efgh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># but much more readable</span>
</span></span></code></pre></div></section><section><h3 id=why-wasnt-this-taught-last-week>why wasn&rsquo;t this taught last week</h3><p>you should understand what the tooling does</p><ul><li>there&rsquo;s a lot the tooling can do</li><li>but it&rsquo;s important to understand the fundamentals of why</li><li>e.g. <code>shellcraft.i386.linux.sh()</code></li><li>don&rsquo;t use it</li></ul></section><section><h3 id=but-now-there-is-no-win-function>but now, there is no win function</h3><ul><li>so we can&rsquo;t jump to a win function anymore</li><li>so what if we just write our own win function?</li></ul><blockquote><p>programming in my security??</p></blockquote></section></section><section><section data-shortcode-section><h2 id=shellcode>shellcode</h2></section><section><h3 id=shellcode-1>üêöshellcode</h3><ul><li>Q: What is a win() function (or any function)?</li></ul></section><section><h3 id=shellcode-2>üêöshellcode</h3><ul><li>Q: what is a win() function (or any function)?</li><li>A: it&rsquo;s just a sequence of assembly instructions</li></ul></section><section><h3 id=shellcode-3>üêöshellcode</h3><ul><li>Q: what is a win() function (or any function)?</li><li>A: it&rsquo;s just a sequence of assembly instructions<ul><li>assembly is just bytes</li></ul></li></ul></section><section><h3 id=shellcode-4>üêöshellcode</h3><ul><li>Q: what is a win() function (or any function)?</li><li>A: it&rsquo;s just a sequence of assembly instructions<ul><li>assembly is just bytes</li><li>bytes is just data (which we can send)</li></ul></li></ul></section><section><h3 id=shellcode-5>üêöshellcode</h3><ul><li>Q: what is a win() function (or any function)?</li><li>A: it&rsquo;s just a sequence of assembly instructions<ul><li>assembly is just bytes</li><li>bytes is just data (which we can send)</li></ul></li><li>if we write some assembly instructions, and point EIP at them, we can get code execution (e.g. read/write, pop a shell)!</li></ul></section><section><h3 id=what-does-this-like-look>what does this like look</h3><p>in memory</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>    <span style=color:#ae81ff>0x48</span>  [   <span style=color:#a6e22e>ARGS</span>   ] <span style=color:#f92672>&lt;</span> 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x44</span>  [ <span style=color:#ae81ff>00000030</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>EIP</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x40</span>  [ <span style=color:#a6e22e>AA094101</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>hacks</span> <span style=color:#a6e22e>nasa</span><span style=color:#f92672>?</span> 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x3C</span>  [ <span style=color:#ae81ff>12350</span><span style=color:#a6e22e>ADA</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>calls</span> <span style=color:#a6e22e>back</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>c2</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x38</span>  [ <span style=color:#ae81ff>48392918</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>deploys</span> <span style=color:#a6e22e>malware</span> <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>system</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x34</span>  [ <span style=color:#ae81ff>59059474</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>pops</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>shell</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x30</span>  [ <span style=color:#ae81ff>56486420</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>buffer</span>
</span></span></code></pre></div></section><section><h3 id=some-helpful-instructions->some helpful instructions :)</h3><p>hopefully you&rsquo;ve seen them in 1521/MIPS?</p><pre tabindex=0><code>    mov a, b        # a = b
    add a, value    # a += value
    sub a, value    # a -= value
    xor a, b        # a ^= b
    and a, b        # a &amp;= b
    push a          # push a onto stack, dec esp - 4
    pop a           # pop into a from stack, add esp + 4
    int 0x80        # syscall
</code></pre><p><a href=http://cgi.cse.unsw.edu.au/~z5164500/syscall/>syscall table</a></p></section><section><h3 id=what-is-a-syscall>what is a syscall</h3><ul><li>we don&rsquo;t have privilege to perform certain actions, but the kernel does<ul><li>e.g. reading/writing, networking, creating processes</li></ul></li><li>a syscall is kinda like a kernel API to invoke these services on our behalf</li></ul></section><section><h3 id=idc-how-do-we-binsh>idc, how do we /bin/sh</h3><p>basically this</p><pre tabindex=0><code>eax = 0xB (11)
ebx = char __user *
ecx = char __user * __user *
edx = char __user * __user *
esi = struct pt_regs *
</code></pre></section><section><h3 id=most-of-those-dont-matter>most of those don&rsquo;t matter</h3><p>this is how you invoke <code>/bin/sh</code></p><pre tabindex=0><code>eax = OxB (important, the sycall number)
ebx = *(&#34;/bin/sh&#34;) (important, this is the program to run) 
ecx = NULL (not important, this is arguments to that program)
edx = NULL (not important, this is environment variables)
esi = NULL (not important, idk what this is)
</code></pre></section><section><h3 id=so-how-do-we-do-that>so how do we do that</h3><p>one example</p><pre tabindex=0><code>mov eax, 0xB        # eax = 12
mov ebx, 0x8041234  # imagine that is the pointer to /bin/sh
xor ecx, ecx        # ecx = NULL
xor edx, edx        # edx = NULL
xor esi, esi        # esi = NULL

int 0x80            # invoke syscall
</code></pre></section><section></section></section><section><h2 id=demo>demo</h2><ul><li>poppin a shell with ./runner</li></ul></section><section><section data-shortcode-section><h2 id=my-payload-isnt-working-help>my payload isn&rsquo;t working, help</h2><ul><li>no /bin/sh&rsquo;s?</li><li>NOPNOPNOPNOPNOPNOP</li><li>egghunters</li></ul></section><section><h2 id=the-binsh-problamo>The /bin/sh problamo</h2><p>/bin/sh\00</p><pre tabindex=0><code>                ‚Üì‚Üì that&#39;s a null byte :(
 hs/  |  push 0x0068732F
nib/  |  push 0x6E69622F    
</code></pre><p>¬†</p><ul><li>what if:<ul><li>the program stops reading at a null byte/newline?</li><li>the program strips/parses them out?</li></ul></li></ul></section><section><h2 id=the-binsh-solutiomo>The /bin/sh solutiomo</h2><ul><li>Pad out /bin/sh -> /bin//sh</li></ul><pre tabindex=0><code>                ‚Üì‚Üì that&#39;s not a null byte :)
hs//  |  push 0x68732F2F
nib/  |  push 0x6E69622F    
</code></pre><p>¬†</p><blockquote><p>However, what happens to our null byte?</p></blockquote></section><section><h2 id=the-missing-nullbyte>The missing nullbyte</h2><p>We still need to get a nullbyte onto the stack, otherwise it&rsquo;ll just do</p><pre tabindex=0><code>execve(&#39;/bin//sh + &lt;some_garbage_data&gt;&#39;)
</code></pre><p>¬†</p><p>There&rsquo;s plenty of ways to do it, e.g.</p><pre tabindex=0><code>xor eax, eax
push eax
</code></pre></section><section><h2 id=alternatively>alternatively</h2><pre tabindex=0><code>call pwn
    pwn:
    pop ebx                 # ebx now stores &amp;(pwn)
    diff = binsh - pwn      # we find the offset to binsh
    add ebx, diff           # we add the offset
    ## equivalently: lea ebx, [ebx + binsh - pwn]

    ## now ebx stores &amp;binsh, so we call execve or w/e

    binsh: .string &#34;/bin/sh&#34;
</code></pre><p>full payload <a href=https://github.com/lachlan-waugh/6447/blob/main/demos/labs/week03/shell-alternate.py>here</a></p></section><section><h2 id=why-does-that-work>why does that work?</h2><ul><li><p><code>call func</code> will push the return address (the address of the next instruction) onto the stack</p></li><li><p>the return address of <code>call pwn</code> would be &amp;pwn</p></li><li><p>now we have the address of <code>pwn</code>, we just need to offset to <code>binsh</code>, and use that as our address</p></li></ul><p>source: <a href=https://www.aldeid.com/wiki/X86-assembly/Instructions/call>here</a></p></section><section><h1 id=alternatively-2>alternatively #2</h1><ul><li>all of the strings in the program are still accessible to you</li><li>so you could just feed their address in (if any of them are useful of course).</li></ul></section></section><section><section data-shortcode-section><h1 id=nopnopnop>NOPNOPNOP</h1></section><section><h3 id=nopsledin-away>nopsledin&rsquo; away</h3><p>sometimes</p><ul><li>we don&rsquo;t know exactly where our payload will be, or</li><li>the address is a random distance into our buffer.</li></ul><p>¬†</p><pre tabindex=0><code>the start of our input             the leaked address
‚Üì‚Üì‚Üì‚Üì                               ‚Üì‚Üì‚Üì‚Üì
\xDE \xAD \xBE \xEF \xCA \xFE \xBA \xBE \xTR \xIV \xIA \xLl
</code></pre></section><section><h3 id=nopsledin-away-1>nopsledin&rsquo; away</h3><p><code>nop</code> (no-operation) <code>\x90</code> is a single-byte instruction, which does nothing</p><p>¬†</p><p>So what if we padded our input out with those <code>nops</code> (similar to padding we used to reach EIP)</p><pre tabindex=0><code>the start of our input             the leaked address
‚Üì‚Üì‚Üì‚Üì                               ‚Üì‚Üì‚Üì‚Üì
\x90 \x90 \x90 \x90 \x90 \x90 \x90 \xDE \xAD \xBE \xEF \xCA \xFE
</code></pre></section><section><h3 id=what-if-no-nop>what if no nop</h3><p>sometimes you might get WAFed</p><ul><li>if <code>\x90</code> (NOOP) is blocked</li><li>you can just use something else e.g. <code>xchg eax, eax</code></li><li>or any meaningless (for your use) one-byte instruction</li></ul></section></section><section><section data-shortcode-section><h2 id=-egghunter>ü•ö egghunter</h2><ul><li>Q: what if our buffer isn&rsquo;t big enough for a payload?</li></ul></section><section><h2 id=-egghunter-1>ü•ö egghunter</h2><ul><li>Q: what if our buffer isn&rsquo;t big enough for a payload?<ul><li>if we have a big non-overflowable buffer, we can store the payload there (and an egg).</li></ul></li></ul></section><section><h2 id=-egghunter-2>ü•ö egghunter</h2><ul><li>Q: what if our buffer isn&rsquo;t big enough for a payload?<ul><li>if we have a big non-overflowable buffer, we can store the payload there (and an egg).</li><li>then in our overflowable buffer, we put a small payload which will search for & execute the egg.</li></ul></li></ul></section><section><h2 id=-omelette-egghunter>üç≥ omelette egghunter</h2><ul><li>Q: what if we don&rsquo;t any buffer big enough?</li></ul></section><section><h2 id=-omelette-egghunter-1>üç≥ omelette egghunter</h2><ul><li>Q: what if we don&rsquo;t any buffer big enough?</li><li>A: if we have a number of small buffers<ul><li>store a bit of the payload in each buffer</li></ul></li></ul></section><section><h2 id=-omelette-egghunter-2>üç≥ omelette egghunter</h2><ul><li>Q: what if we don&rsquo;t any buffer big enough?</li><li>A: if we have a number of small buffers<ul><li>store a bit of the payload in each buffer</li><li>use the egghunter to find each of those eggs.</li></ul></li></ul></section><section><h2 id=-omelette-egghunter-3>üç≥ omelette egghunter</h2><ul><li>Q: what if we don&rsquo;t any buffer big enough?</li><li>A: if we have a number of small buffers<ul><li>store a bit of the payload in each buffer</li><li>use the egghunter to find each of those eggs.</li><li>chain their execution, to execute our full payload.</li></ul></li></ul></section></section><section><h2 id=tutorial>tutorial</h2><p>now it&rsquo;s your turn!</p><ul><li><span class=fragment>Print &ldquo;hello world\n&rdquo; to stdout.</span></li><li><span class=fragment>Print a user entered string (from stdin) to stdout.</span></li><li><span class=fragment>Open a file &lsquo;flag.txt&rsquo;, read 10 bytes from it, print them, and close the file</span></li><li><span class=fragment>Transcribe the given code into assembly</span></li></ul></section><section><h2 id=walkthrough>walkthrough</h2></section></div></div><script type=text/javascript src=../reveal-hugo/object-assign.js></script><a href=../reveal-js/css/print/ id=print-location style=display:none></a><script type=text/javascript>var printLocationElement=document.getElementById("print-location"),link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?"pdf.css":"paper.css"),document.getElementsByTagName("head")[0].appendChild(link)</script><script type=application/json id=reveal-hugo-site-params>null</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=../reveal-js/js/reveal.js></script><script type=text/javascript>function camelize(e){return e&&Object.keys(e).forEach(function(t){newK=t.replace(/(_\w)/g,function(e){return e[1].toUpperCase()}),newK!=t&&(e[newK]=e[t],delete e[t])}),e}var revealHugoDefaults={center:!0,controls:!0,history:!0,progress:!0,transition:"slide"},revealHugoSiteParams=JSON.parse(document.getElementById("reveal-hugo-site-params").innerHTML),revealHugoPageParams=JSON.parse(document.getElementById("reveal-hugo-page-params").innerHTML),options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options)</script><script type=text/javascript src=../reveal-js/plugin/markdown/marked.js></script><script type=text/javascript src=../reveal-js/plugin/markdown/markdown.js></script><script type=text/javascript src=../reveal-js/plugin/highlight/highlight.js></script><script type=text/javascript src=../reveal-js/plugin/zoom-js/zoom.js></script><script type=text/javascript src=../reveal-js/plugin/notes/notes.js></script></body></html>