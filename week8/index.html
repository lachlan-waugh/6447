<!doctype html><html lang=en><head><meta charset=utf-8><title>8: heap</title>
<meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=../reveal-js/css/reset.css><link rel=stylesheet href=../reveal-js/css/reveal.css><link rel=stylesheet href=../reveal-js/css/theme/black.css id=theme><link rel=stylesheet href=../highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section><h2 id=well-get-started-at-16805>We&rsquo;ll get started at 1[68]:05</h2></section><section data-noprocess data-shortcode-slide class=center><h1 id=heap-exploitation>heap exploitation</h1><h3 id=6447-week8>6447 week8</h3></section><section><h2 id=good-faith-policy>Good faith policy</h2><p>We expect a high standard of professionalism from you at all times while you are taking any of our courses. We expect all students to act in good faith at all times</p><p><em>TLDR: Don&rsquo;t be a <del>dick</del> jerk</em></p><p><a href=https://sec.edu.au/good-faith-policy>sec.edu.au/good-faith-policy</a></p></section><section><h3 id=chunks>chunks</h3><p><code>malloc()</code> returns chunks (blocks of memory)</p><ul><li>chunks can either be <strong>in-use</strong> or <strong>free</strong></li><li>each has different metadata associated with it</li></ul></section><section><h3 id=in-use-chunks>in-use chunks</h3><section data-shortcode-section><img src=../assets/img/week08/in-use.png height=500px></section><section><h4 id=what-is-the-metadata>what is the &ldquo;metadata&rdquo;</h4><ul><li>size of the chunk</li><li>last 3 bits:<ul><li>1: chunk is in main arena</li><li>2: chunk is mmap&rsquo;d (not in the heap)</li><li>3: previous chunk in use</li></ul></li></ul><blockquote><p>mixing metadata (control) & user data?</p></blockquote></section><section><img src=../img/week08/allocated.png height=500px></section></section><section><h3 id=free-chunks>free chunks</h3><section data-shortcode-section><blockquote><p>a bunch of other metadata</p></blockquote><ul><li>size of the previous chunk</li><li>a pointer to the next / previous chunk</li><li>basically just a look of <em>control</em> characters</li><li>etc</li></ul></section><section><img src=../img/week08/free.png height=500px></section></section><section><h2 id=free><code>free()</code></h2><section data-shortcode-section><blockquote><p>after a chunk is <code>free()</code>&rsquo;d, information about it is stored in a &lsquo;bin&rsquo;</p></blockquote><ul><li>fast bins</li><li>non-fast<ul><li>unsorted bins</li><li>small/Large</li></ul></li><li>tcache</li></ul></section><section><h3 id=fast-bins>Fast-bins</h3><ul><li><p>used to store information about <u>small</u> chunks</p></li><li><p>chunks are stored in size-specific bins</p><ul><li>16, 24, 32, &mldr; 88 bytes (10 total)</li></ul></li><li><p>a fast-bin is a singly-linked list</p><ul><li>new chunks are added to the start (LIFO)</li><li>chunks aren&rsquo;t combined with adjacent chunks</li></ul></li></ul></section><section><h3 id=unsorted-bins>Unsorted bins</h3><ul><li>used to store information about <u>large</u> chunks</li><li>all chunks are stored in a single bin (of various sizes)</li><li>later, chunks are sorted by malloc for quicker re-use.</li></ul></section><section><h3 id=other-bins>Other bins</h3><ul><li>normal bins are divided into:<ul><li>62 small bins (chunks of <em>same</em> size)</li><li>2 large bins (chunks of <em>similar</em> sizes)</li></ul></li><li>chunk sizes may be changed<ul><li>chunks are coalesced with adjacent chunks</li><li>large chunks may be split on a <code>malloc()</code></li><li>it&rsquo;s a doubly-linked list to help with this</li></ul></li></ul></section><section><h3 id=tcache-bins>Tcache bins</h3><blockquote><p><a href=https://sourceware.org/glibc/wiki/MallocInternals#Thread_Local_Cache_.28tcache.29>thread-local cache</a></p></blockquote><ul><li>pretty insecure tbh (but very fast)</li><li>basically doesn&rsquo;t have any checks</li><li>each bin can only store 7 chunks</li></ul></section></section><section><section data-shortcode-section><h3 id=a-quick-note>A quick note</h3><ul><li><p><em>we&rsquo;re attacking the heap implementation, not bad programming. So different systems/versions may change how the program acts (& if your exploit works)</em></p></li><li><p>depending on your OS/LIBC version/<del>the orientation of the sun</del>, you might get errors, e.g. double <code>free()</code> detected blah blah.</p></li></ul></section><section><h3 id=solution>Solution?</h3><ul><li>just use docker<ul><li><code>docker run -d --rm -h banana --name banana -v $(pwd):/ctf/work --cap-add=SYS_PTRACE plsiamlegit/6447-ubuntu:pwndocker</code></li><li><code>docker exec -it banana /bin/bash</code></li></ul></li></ul></section></section><section><h2 id=use-after-free>use after free</h2><section data-shortcode-section><h3 id=how-does-free-work>how does <code>free()</code> work</h3><ul><li>after a chunk is <code>free()</code>&rsquo;d<ul><li>what happens to pointers to it?</li><li>what happens to it&rsquo;s contents?</li></ul></li></ul></section><section><h3 id=answers>answers</h3><ul><li>Q: what happens to a pointer to it?</li></ul><blockquote><p>nothing, we can still use the pointer</p></blockquote><p>Â </p><ul><li>Q: what happens to it&rsquo;s contents?</li></ul><blockquote><p>it gets replaced with that metadata</p></blockquote></section><section><h3 id=exploiting-this>exploiting this?</h3><ul><li>modifying an existing chunk</li><li>forging chunks</li></ul></section><section><h3 id=modifying-an-existing-chunk>modifying an existing chunk</h3><p>TODO</p></section><section><h3 id=forging-chunks>forging chunks</h3><p>if we modified the metadata (e.g. the next chunk ptr), then malloc(&mldr;) would return memory we tell it to.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>free</span>(<span style=color:#a6e22e>chunk</span>)     <span style=color:#75715e>// bin: chunk -&gt; NULL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>*</span><span style=color:#a6e22e>chunk</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AAAA&#34;</span> <span style=color:#75715e>// bin: chunk -&gt; 0x41414141 -&gt; ????
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>malloc</span>(<span style=color:#f92672>...</span>)     <span style=color:#75715e>// bin: 0x41414141 -&gt; ????
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>malloc</span>(<span style=color:#f92672>...</span>)     <span style=color:#75715e>// bin: ????
</span></span></span><span style=display:flex><span><span style=color:#75715e>// the second call to malloc returns 0x41414141
</span></span></span></code></pre></div></section><section><h3 id=demo>demo</h3></section></section><section><h2 id=double-free>double free</h2><section data-shortcode-section><ul><li>what happens if we <code>free()</code>&rsquo;d a chunk twice?<ul><li>first time: it&rsquo;s added to the free list</li><li>second time: it&rsquo;s added to the free list, again?</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>free</span>(<span style=color:#a6e22e>chunk</span>)     <span style=color:#75715e>// bin: chunk -&gt; NULL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>free</span>(<span style=color:#a6e22e>chunk</span>)     <span style=color:#75715e>// bin: chunk -&gt; chunk -&gt; NULL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>malloc</span>(<span style=color:#f92672>...</span>)     <span style=color:#75715e>// bin: chunk -&gt; NULL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>malloc</span>(<span style=color:#f92672>...</span>)     <span style=color:#75715e>// bin: NULL
</span></span></span></code></pre></div><p>both calls to <code>malloc()</code> return the same chunk?</p></section><section><p>there&rsquo;s basic protections against double <code>free()</code>s, and it&rsquo;ll <code>SIGABORT</code> when detected
<img src=../img/week08/double_free.png></p><blockquote><p>but what if you just&mldr;</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>free</span>(<span style=color:#a6e22e>chunk_1</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>free</span>(<span style=color:#a6e22e>chunk_2</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>free</span>(<span style=color:#a6e22e>chunk_1</span>)
</span></span></code></pre></div></section><section><h3 id=demo>demo</h3></section></section><section><h2 id=pwndbg-stuff>PWNDBG stuff</h2><ul><li><code>vis_heap_chunks</code></li><li><code>bins</code></li><li><code>heap</code></li><li><code>arena</code></li></ul></section><section><h2 id=tutorial>tutorial</h2></section><section><h2 id=walkthrough>walkthrough</h2></section></div></div><script type=text/javascript src=../reveal-hugo/object-assign.js></script><a href=../reveal-js/css/print/ id=print-location style=display:none></a><script type=text/javascript>var printLocationElement=document.getElementById("print-location"),link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?"pdf.css":"paper.css"),document.getElementsByTagName("head")[0].appendChild(link)</script><script type=application/json id=reveal-hugo-site-params>null</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=../reveal-js/js/reveal.js></script><script type=text/javascript>function camelize(e){return e&&Object.keys(e).forEach(function(t){newK=t.replace(/(_\w)/g,function(e){return e[1].toUpperCase()}),newK!=t&&(e[newK]=e[t],delete e[t])}),e}var revealHugoDefaults={center:!0,controls:!0,history:!0,progress:!0,transition:"slide"},revealHugoSiteParams=JSON.parse(document.getElementById("reveal-hugo-site-params").innerHTML),revealHugoPageParams=JSON.parse(document.getElementById("reveal-hugo-page-params").innerHTML),options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options)</script><script type=text/javascript src=../reveal-js/plugin/markdown/marked.js></script><script type=text/javascript src=../reveal-js/plugin/markdown/markdown.js></script><script type=text/javascript src=../reveal-js/plugin/highlight/highlight.js></script><script type=text/javascript src=../reveal-js/plugin/zoom-js/zoom.js></script><script type=text/javascript src=../reveal-js/plugin/notes/notes.js></script></body></html>