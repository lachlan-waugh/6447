<!doctype html><html lang=en><head><meta charset=utf-8><title>7: rop</title>
<meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=../reveal-js/css/reset.css><link rel=stylesheet href=../reveal-js/css/reveal.css><link rel=stylesheet href=../reveal-js/css/theme/black.css id=theme><link rel=stylesheet href=../highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section><h2 id=well-get-started-at-1805>We&rsquo;ll get started at 18:05</h2></section><section data-noprocess data-shortcode-slide class=center><h1 id=return-oriented-programming>return oriented programming</h1><h3 id=6447-week7>6447 week7</h3></section><section><h2 id=house-cleaning>House cleaning</h2><section data-shortcode-section><h3 id=fuzzer>Fuzzer</h3><ul><li>Midpoint check-in is due this Sunday 6pm</li><li>Make sure you&rsquo;ve got a working prototype</li></ul></section><section><h3 id=midterm>Midterm</h3><ul><li>How&rsquo;d you find it</li></ul></section></section><section><h2 id=a-summary-so-far>A summary so far</h2><section data-shortcode-section><h3 id=weeks-23>weeks 2/3</h3><ul><li>buffer overflow → <code>win()</code></li><li>shellcode (building a <code>win()</code>)</li></ul><p> </p><h3 id=now>now:</h3><ul><li>rop/ret2 (building a <code>win()</code> when NX is on)</li></ul></section><section><h3 id=buffer-overflows>buffer overflows</h3><ul><li><p>Abusing functions which can read more data than they have allocated memory for (<code>gets</code>, <code>strcpy</code>)</p></li><li><p>Allows us to control the stack (local vars, ret)</p></li><li><p><em>Mitigations</em>: ASLR/PIE/Stack canaries</p></li><li><p><em>Breaking them</em>: leaking addresses/the canary</p></li></ul></section><section><h3 id=shellcode>shellcode</h3><ul><li><p>Once we can control execution of the program (e.g. changing the return address), where do we go?</p><ul><li>We trick it into treating our user-supplied as code.</li><li>Then jump to the code</li></ul></li><li><p><em>Mitigations</em>: NX, buffer too small for a payload</p></li><li><p><em>Breaking them</em>: ROP, EggHunters</p></li></ul></section></section><section><section data-shortcode-section><h2 id=rop>ROP</h2><ul><li><p>instead of writing our own assembly instruction, we re-use existing instructions from the program.</p></li><li><p>We use instructions preceding a <code>ret</code> (gadgets), so we can jump to them, execute them, and jump back.</p></li><li><p>We chain these gadgets so we can execute a full payload, by: jumping to first one, executing it, jumping back, jumping to the second one, etc.</p></li></ul></section><section><h3 id=how-does-ret-work>how does ret work?</h3><p>it grabs what rsp is pointing to, and jumps there</p><pre tabindex=0><code>pop rcx
jmp rcx
</code></pre><blockquote><p>rsp is integral to our ropchain</p></blockquote></section><section><h3 id=why-does-it-jump-to-esp>why does it jump to esp?</h3><p>ret is the last thing in a function call</p><ul><li>it&rsquo;s called after:<ul><li>local vars are cleaned up, and</li><li><code>rbp</code> is grabbed off the stack</li></ul></li><li>so <code>rsp</code> should is pointing at the return address</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>    <span style=color:#ae81ff>0x18</span>  [   <span style=color:#a6e22e>ARGS</span>   ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>parameters</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x14</span>  [   <span style=color:#a6e22e>RIP</span>    ] <span style=color:#f92672>&lt;-</span> <span style=color:#f92672>+++</span><span style=color:#a6e22e>rsp</span> <span style=color:#a6e22e>now</span> <span style=color:#a6e22e>points</span> <span style=color:#a6e22e>here</span><span style=color:#f92672>+++</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x10</span>  [   <span style=color:#a6e22e>RBP</span>    ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>cleaned</span> <span style=color:#a6e22e>up</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>leave</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x0C</span>  [ <span style=color:#a6e22e>AAAAAAAA</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>local</span> <span style=color:#a6e22e>vars</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>dealloc</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>d</span>
</span></span></code></pre></div></section><section><h3 id=how-does-a-ropchain-work>how does a ropchain work</h3><p>it&rsquo;s going to execute each gadget, then grab the next one off the stack, and execute that</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>    <span style=color:#ae81ff>0x18</span>  [ <span style=color:#a6e22e>GADGET_3</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>parameters</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x18</span>  [ <span style=color:#a6e22e>GADGET_2</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>parameters</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x14</span>  [ <span style=color:#a6e22e>GADGET_1</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#f92672>+++</span><span style=color:#a6e22e>rsp</span> <span style=color:#a6e22e>now</span> <span style=color:#a6e22e>points</span> <span style=color:#a6e22e>here</span><span style=color:#f92672>+++</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x10</span>  [   <span style=color:#a6e22e>RBP</span>    ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>cleaned</span> <span style=color:#a6e22e>up</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>leave</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x0C</span>  [ <span style=color:#a6e22e>AAAAAAAA</span> ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>local</span> <span style=color:#a6e22e>vars</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>dealloc</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>d</span>
</span></span></code></pre></div></section><section><h3 id=gadgets>Gadgets</h3><ul><li>Instructions can comprise of multiple-bytes<ul><li>If jump to an offset within an instructions</li><li>We could have an entirely new instruction</li></ul></li></ul><pre tabindex=0><code>    0xAABBCCDD          0xAABBCCDD      0xAABBCCDD
      ^^^^^^^^              ^^                ^^^^
    MOV RAX, 12         XOR RAX, RAX       INC RAX; CALL WIN
</code></pre><blockquote><p>note, I made those ^^^ up entirely</p></blockquote></section><section><h3 id=old-shellcode>Old shellcode</h3><pre tabindex=0><code>/* argv = envp = NULL */
xor rcx, rdx
xor rdx, rdx

/* push &#39;/bin/sh&#39; onto stack */
push 0x732f2f6e69622f
mov rbx, rsp

/* call execve() */
mov rax, 0xb /* Syscall Number 11 */
syscall    /* Trigger syscall */
</code></pre></section><section><h3 id=how-do-we-replicate-this>How do we replicate this</h3><p><code>execve('/bin/sh', NULL, NULL)</code></p><pre tabindex=0><code>RAX = 0x3B # (59)
RBX = address to /bin/sh
RCX = NULL
RDX = NULL
syscall
</code></pre></section><section><h3 id=now-thats-its-rop>Now that&rsquo;s it&rsquo;s ROP</h3><p>Instead of raw instructions, we&rsquo;ll use gadgets</p><pre tabindex=0><code>[GADGET_1] # RAX := 0x3B # (59)
[GADGET_2] # RBX := address to /bin/sh
[GADGET_3] # RCX := NULL
[GADGET_4] # RDX := NULL
[GADGET_5] # Syscall
</code></pre></section><section><h3 id=how-do-we-find-gadgets>How do we find gadgets?</h3><ul><li><a href=https://github.com/sashs/Ropper>Ropper</a></li><li><a href=https://github.com/JonathanSalwan/ROPgadget>ROPgadget</a></li><li><a href=https://github.com/Ben-Lichtman/ropr>ropr</a></li></ul></section><section><h3 id=finding-gadgets>Finding gadgets</h3><pre tabindex=0><code>&gt; ROPgadget --binary ropme --search &#39;pop rbx&#39;
0x0804832d : pop rbx ; ret

&gt; ROPgadget --binary ropme --search&#39;xor rcx&#39;
0x080484b5 : xor rcx, rcx ; ret

&gt; ROPgadget --binary ropme --search &#39;xor rdx&#39;
0x080484b8 : xor rdx, rdx ; ret

&gt; ROPgadget --binary ropme --search &#39;syscall&#39;
0x080484bb : mov rax, 0x3B ; int 0x80
</code></pre></section><section><h3 id=using-strings-and-values>Using strings and values</h3><p><code>pop rbx; ret</code> grabs the next address on the stack, and stores it in <code>rbx</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>p32</span>(<span style=color:#ae81ff>0x08041234</span>) <span style=color:#75715e>// pop rbx; ret;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>p32</span>(<span style=color:#ae81ff>0x0804abcd</span>) <span style=color:#75715e>// address of &#34;/bin/sh&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>// now rbx stores a pointer to &#34;/bin/sh&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>p32</span>(<span style=color:#ae81ff>0x08041234</span>) <span style=color:#75715e>// pop rbx; ret;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>p32</span>(<span style=color:#ae81ff>0xA</span>)        <span style=color:#75715e>// 10
</span></span></span><span style=display:flex><span><span style=color:#75715e>// now rbx == 10
</span></span></span></code></pre></div></section><section><h3 id=getting-the-stack-address>getting the stack address</h3><p>we could grab the stack pointer, and store it in <code>rbx</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>push esp, pop rbx; ret;
</span></span><span style=display:flex><span><span style=color:#75715e>// now rbx will store &amp;esp
</span></span></span></code></pre></div><blockquote><p>generally both instructions will need to be in the same gadget</p></blockquote></section><section><h3 id=what-should-a-payload-look-like>What should a payload look like?</h3><pre tabindex=0><code>[  PADDING  ] &lt;== our first gadget should overwrite ret
[  RAX=0x3B ]
[  POP RBX  ]
[  &amp;BIN SH  ]
[  XOR RCX  ]
[  XOR RDX  ]
[  SYSCALL  ]
</code></pre></section><section><h3 id=how-else-could-we-get-a-shell>How else could we get a shell?</h3><ul><li>we can also call functions!</li><li>what if the program already calls system?</li></ul><pre tabindex=0><code>CALL SYSTEM
PUSH &amp;(&#39;/bin/sh&#39;)
</code></pre></section><section><h3 id=demo>DEMO</h3></section></section><section><h2 id=ret2libc>Ret2Libc</h2><section data-shortcode-section><h3 id=what-if-the-program-doesnt-have-good-enough-gadgets>what if the program doesn&rsquo;t have (good) enough gadgets?</h3><ul><li>we can jump to our own code</li><li>we can also jump to any used libraries</li></ul></section><section><ul><li>libc stores all of the useful <em>&ldquo;builtin&rdquo;</em> functionality (<code>printf</code>, <code>gets</code>, etc)</li><li>that&rsquo;s a whole lot of gadgets we could utilise</li></ul></section><section><ul><li>for a payload we&rsquo;ll need to find:<ul><li>the base address</li><li>the libc version (to determine offsets)*</li><li>a helpful function</li></ul></li></ul><blockquote><p>* <em>function offsets vary by LIBC version, you can find the correct offsets <a href=https://libc.nullbyte.cat/>here</a></em></p></blockquote></section><section><h3 id=pwntools>pwntools</h3><ul><li>alternatively, you can do it with <code>pwntools</code></li><li>similar to setting binary base, you set the libc base</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>libc <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#34;libc_version.so&#34;</span>)
</span></span><span style=display:flex><span>libc<span style=color:#f92672>.</span>address <span style=color:#f92672>=</span> printf_leak <span style=color:#f92672>-</span> libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;printf&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># libc.address is now the correct address</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># you can directly access functions like:</span>
</span></span><span style=display:flex><span>libc<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;system&#39;</span>] <span style=color:#75715e># etc...</span>
</span></span></code></pre></div></section><section><h3 id=helpful-stuff>helpful stuff</h3><ul><li>you can search for stuff in pwntools</li><li>use the functions elf.search() and next()</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>elf <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#39;binary_file&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># you can find strings</span>
</span></span><span style=display:flex><span>next(elf<span style=color:#f92672>.</span>search(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/bin/sh&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># you can also find gadgets</span>
</span></span><span style=display:flex><span>next(elf<span style=color:#f92672>.</span>search(asm(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;mov rax, 0xb; ret&#39;</span>, os<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;linux&#39;</span>, arch<span style=color:#f92672>=</span>e<span style=color:#f92672>.</span>arch)))
</span></span></code></pre></div></section><section><h2 id=demo>Demo</h2><blockquote><p>ret2libc</p></blockquote></section></section><section><h2 id=tutorial>Tutorial</h2><blockquote><p>3 chals this week, try to solve them all</p></blockquote></section><section><h2 id=walkthrough>Walkthrough</h2><blockquote><p>image-viewer?</p></blockquote></section></div></div><script type=text/javascript src=../reveal-hugo/object-assign.js></script><a href=../reveal-js/css/print/ id=print-location style=display:none></a><script type=text/javascript>var printLocationElement=document.getElementById("print-location"),link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?"pdf.css":"paper.css"),document.getElementsByTagName("head")[0].appendChild(link)</script><script type=application/json id=reveal-hugo-site-params>null</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=../reveal-js/js/reveal.js></script><script type=text/javascript>function camelize(e){return e&&Object.keys(e).forEach(function(t){newK=t.replace(/(_\w)/g,function(e){return e[1].toUpperCase()}),newK!=t&&(e[newK]=e[t],delete e[t])}),e}var revealHugoDefaults={center:!0,controls:!0,history:!0,progress:!0,transition:"slide"},revealHugoSiteParams=JSON.parse(document.getElementById("reveal-hugo-site-params").innerHTML),revealHugoPageParams=JSON.parse(document.getElementById("reveal-hugo-page-params").innerHTML),options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options)</script><script type=text/javascript src=../reveal-js/plugin/markdown/marked.js></script><script type=text/javascript src=../reveal-js/plugin/markdown/markdown.js></script><script type=text/javascript src=../reveal-js/plugin/highlight/highlight.js></script><script type=text/javascript src=../reveal-js/plugin/zoom-js/zoom.js></script><script type=text/javascript src=../reveal-js/plugin/notes/notes.js></script></body></html>